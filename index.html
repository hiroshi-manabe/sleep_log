<!doctype html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sleep Log</title>
<script type="text/javascript">
  let data = {};
      
  function load() {
      let d = JSON.parse(localStorage.getItem("data"));
      if (!d) {
          return { "values" : [] };
      }
      else {
          return d;
      }
  }
  
  function save(d) {
      localStorage.setItem("data", JSON.stringify(d));
  }
  
  function init() {
      data = load();
      printValues(data);
  }
  
  function record(d, date, isOnset, isSpontaneous) {
      d.values.push({"date" : date.getTime(), "isOnset" : isOnset, "isSpontaneous" : isSpontaneous});
      save(data);
      printValues(d);
  }

  function zeroPaddingMax2(num, length) {
      return `0${num}`.slice(-length);
  };

  function formatDate(d) {
      return zeroPaddingMax2(d.getMonth() + 1, 2) + "/" + zeroPaddingMax2(d.getDate(), 2) + "（" + "日月火水木金土".charAt(d.getDay()) + "） " + zeroPaddingMax2(d.getHours(), 2) + ":" + zeroPaddingMax2(d.getMinutes(), 2);
  }

  function printValues(d) {
      let obj = document.getElementById("result");
      obj.innerHTML = "";
      let count = 0;
      d.values.slice(-40).forEach(function(v) {
          let date = new Date(v.date);
          
          obj.insertAdjacentHTML("afterbegin", "<span>" + formatDate(date) + (v["isOnset"] ? "入眠" : v["isSpontaneous"] ? "覚醒○" : "覚醒") + "</span><br>");
      });
  }

  function update(d, date, isOnset, isSpontaneous) {
      record(d, date, isOnset, isSpontaneous);
  }
  
  function isEmpty(d) {
      return d.values.length === 0;
  }
  
  function isLastOnset(d) {
      if (isEmpty(d)) return false;
      let v = d.values[d.values.length - 1];
      return v.isOnset;
  }

  // Call isEmpty() before calling this
  function getLastTime(d) {
      let v = d.values[d.values.length - 1];
      return v.date;
  }

  function onUpdate(isOnset, isSpontaneous) {
      let date = new Date();
      let inputTime = document.getElementById("time").value;
      let match = inputTime.match(/^(\d+):(\d+)$/);
      if (match) {
          let inputHours = match[1];
          let inputMinutes = match[2];
          if (inputHours > date.getHours() || (inputHours == date.getHours() && inputMinutes >= date.getMinutes())) {
              date.setTime(date.getTime() - 24 * 60 * 60 * 1000);
          }
          date.setHours(inputHours);
          date.setMinutes(inputMinutes);
          if (!isEmpty(data)) {
              let lastTime = getLastTime(data);
              while (date.getTime() - lastTime >= 24 * 60 * 60 * 1000) {
                  date.setTime(date.getTime() - 24 * 60 * 60 * 1000);
              }
              while (date.getTime() < lastTime) {
                  date.setTime(date.getTime() + 24 * 60 * 60 * 1000);
              }
          }
      }
      update(data, date, isOnset, isSpontaneous);
  }

  function onClearOne() {
      if (!isEmpty(data)) {
          data.values.pop();
      }
      save(data);
      printValues(data);
  }
  
  function onClearAll() {
      data = { values: [] };
      save(data);
      printValues(data);
  }
</script>
<style>
  button { font-size: 100%; }
</style>

</head>
<body onload="init();">
  <input id="time" type="time">
  <button onclick="onUpdate(true, false);">寝た</button>
  <button onclick="onUpdate(false, true);">起○</button>
  <button onclick="onUpdate(false, false);">起×</button>
  <button onclick="onClearOne();">削除</button>
  <div id="result">
  </div>
</body>
</html>
